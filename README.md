# KUMA ClickHouse Backup Script (kuma_save_partition_v2)

## –û–ø–∏—Å–∞–Ω–∏–µ
–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∏–∑ **–•—Ä–∞–Ω–∏–ª–∏—â–∞ KUMA**.
–ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ:
- –ó–∞ –æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å
- –ó–∞ –ø—Ä–æ—à–ª—ã–π –¥–µ–Ω—å
- –ó–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞, –ª–∏—Å—Ç–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Ç–µ–Ω–∞–Ω—Ç–æ–≤ (`-listtenants`) –∏ –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ —Å –ø–æ–º–æ—â—å—é –∞—Ä–≥—É–º–µ–Ω—Ç–∞ `-keepdays`.

–°–∫—Ä–∏–ø—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ [–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ KUMA Community](https://kb.kuma-community.ru/books/ustanovka-i-obnovlenie/page/arxivirovnie-i-vosstanovlenie-bd-cerez-clickhouse-backuprestore). 

> [!WARNING]
> –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã—à–µ –ø–æ –≥–ª–∞–≤–µ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞**.

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π —Å–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ **KUMA Storage**
- –ü—Ä–µ–¥–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∫–∞–ø–æ–≤ (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤—ã—à–µ)
- –î–æ—Å—Ç—É–ø –¥–æ KUMA Core –ø–æ—Ä—Ç: `7223/tcp` (API)
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–∞–∫–µ—Ç [`jq`](https://stedolan.github.io/jq/) –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å KUMA —Å —Ä–æ–ª—å—é **"–º–ª–∞–¥—à–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫"** –∏–ª–∏ –≤—ã—à–µ, –∏–º–µ—é—â–∏–π:
  - API —Ç–æ–∫–µ–Ω
  - –ü—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–µ–Ω–∞–Ω—Ç–æ–≤ (`GET /tenants`)

> [!NOTE]
> –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤–µ—Ä—Å–∏–∏ KUMA 3.—Ö –∏ 4.0. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –≤–µ—Ä—Å–∏—è—Ö KUMA 3.4 –∏ 4.0

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ KUMA
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Å–æ–æ—Ç–≤–µ—Ç—Å–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –≤—ã—à–µ
3. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å–∫—Ä–∏–ø—Ç–µ:
   ```bash
   TOKEN_KUMA='–≤–∞—à_API_—Ç–æ–∫–µ–Ω'
   CORE_KUMA='–∞–¥—Ä–µ—Å_core_kuma'
   ```
4. –ü–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å–∫—Ä–∏–ø—Ç–µ:
   ```bash
   threshold_free_disk=89
   keep_days=60
   LOG_DIR="/var/log"
   MAX_LOG_SIZE_MB=10  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ª–æ–≥-—Ñ–∞–π–ª–∞ –≤ –ú–ë
   ```
5. –î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
   ```bash
   chmod +x kuma_save_partition_v2.sh
   ```

---

## üß© –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–ø—Ä–∞–≤–∫–∏
```bash
./kuma_backup.sh -h
```

### –≠–∫—Å–ø–æ—Ä—Ç –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å
```bash
./kuma_backup.sh -exportday 20250825 -tenant "Test Tenant"
```

### –≠–∫—Å–ø–æ—Ä—Ç –∑–∞ –≤—á–µ—Ä–∞
```bash
./kuma_backup.sh -exportday yesterday -tenant "Test Tenant"
```

### –≠–∫—Å–ø–æ—Ä—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
```bash
./kuma_backup.sh -exportrange 20250820 20250825 -tenant "Test Tenant"
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤
```bash
./kuma_backup.sh -listtenants
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–∞–ø–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30 –¥–Ω–µ–π)
```bash
./kuma_backup.sh -exportday yesterday -tenant "Test Tenant" -keepdays 30
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±—ç–∫–∞–ø–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `BACKUP_PATH` –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã:
- `backup_kuma_<host>_<tenant>_<partition>_<date>.zip` ‚Äî –∞—Ä—Ö–∏–≤ —Å –¥–∞–Ω–Ω—ã–º–∏
- `backup_kuma_<host>_<tenant>_<partition>_<date>.desc` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Ä–∞–∑–º–µ—Ä, MD5, tenant ID –∏ –ø—Ä.)

---

## üôè –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
- –ú–∏—Ö–∞–∏–ª –ó. ‚Äî –∑–∞ –æ—Å–Ω–æ–≤—É —Å–∫—Ä–∏–ø—Ç–∞  
- –ò—Ä–∏–Ω–∞ –õ–µ–æ ‚Äî –∑–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è